version: '3'

dotenv: ['.env']

vars:
  PROJECT_DIR:
    sh: pwd
  MIGRATIONS_DIR: ./var/migrations
  ENTITIES_DIR: ./internal/infra/repo/entity

tasks:
  migrate-up:
    desc: runs migrations.
    cmds:
      - goose -dir {{ .MIGRATIONS_DIR }} postgres "{{ .PG_DSN }}" up

  migrate-down:
    desc: revert migrations.
    cmds:
      - goose -dir {{ .MIGRATIONS_DIR }} postgres "{{ .PG_DSN }}" down

  generate-ent:
    desc: generate entities.
    cmds:
      - sqlboiler psql --no-tests -o ./internal/infra/repo/entity  -c ./var/config/.sqlboiler.toml
    requires:
      vars: [PG_PASSWORD]
    generates:
      - "pkg/gen/sqlboiler"

  generate-server:
    desc: generate server from OpenAPI v3.
    cmds:
      - werf run --docker-options="-u $(id -u):$(id -g) -v `pwd`/:/app -w /app" --dev oapi-codegen -- oapi-codegen -o ./internal/common/service/server/customer/server.go -package=customer -generate=std-http ./api/customer.server.yaml
      - werf run --docker-options="-u $(id -u):$(id -g) -v `pwd`/:/app -w /app" --dev oapi-codegen -- oapi-codegen -o ./internal/common/service/server/customer/types.go -package=customer -generate=types ./api/customer.server.yaml
  
  generate-blockchain-client:
    desc: generate solc buids and blockchain client from sol contracts
    cmds:
      - solc --optimize --abi --bin --overwrite -o var/builds var/contracts/*.sol
      - var/scripts/bindings.sh